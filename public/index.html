<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EMK Admin Panel</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
    --bg: #0a0a0a;
    --bg2: #111111;
    --bg3: #1a1a1a;
    --border: #222;
    --red: #e63946;
    --red2: #c1121f;
    --text: #f0f0f0;
    --muted: #666;
    --success: #2ecc71;
    --warning: #f39c12;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'Syne', sans-serif; }

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
#loginPage {
    display: flex; height: 100vh;
}
.login-left {
    flex: 1; background: var(--bg2);
    display: flex; flex-direction: column; justify-content: space-between;
    padding: 48px; border-right: 1px solid var(--border);
    position: relative; overflow: hidden;
}
.login-left::before {
    content: ''; position: absolute; top: -200px; left: -200px;
    width: 500px; height: 500px;
    background: radial-gradient(circle, rgba(230,57,70,0.08) 0%, transparent 70%);
    pointer-events: none;
}
.login-logo { display: flex; align-items: center; gap: 10px; }
.login-logo-diamond {
    width: 10px; height: 10px; background: var(--red);
    transform: rotate(45deg);
}
.login-logo span { font-size: 13px; font-weight: 700; letter-spacing: 3px; color: var(--muted); text-transform: uppercase; }
.login-hero { margin-top: auto; margin-bottom: auto; }
.login-hero h1 { font-size: 52px; font-weight: 800; line-height: 1.1; }
.login-hero h1 span { color: var(--red); display: block; }
.login-hero p { color: var(--muted); margin-top: 16px; font-size: 14px; line-height: 1.7; max-width: 320px; }
.login-features { display: flex; flex-direction: column; gap: 16px; }
.login-feature { display: flex; align-items: center; gap: 12px; }
.login-feature-icon { width: 32px; height: 32px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
.login-feature-text strong { display: block; font-size: 13px; font-weight: 600; }
.login-feature-text span { font-size: 12px; color: var(--muted); }
.login-footer { font-size: 11px; color: var(--muted); }

.login-right {
    width: 480px; display: flex; align-items: center; justify-content: center;
    padding: 48px;
}
.login-form-wrap { width: 100%; max-width: 360px; }
.login-form-wrap h2 { font-size: 28px; font-weight: 700; margin-bottom: 6px; }
.login-form-wrap p { color: var(--muted); font-size: 13px; margin-bottom: 40px; }

.form-group { margin-bottom: 16px; }
.form-group label { display: block; font-size: 11px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
.form-group input {
    width: 100%; background: var(--bg3); border: 1px solid var(--border);
    color: var(--text); padding: 12px 16px; font-size: 14px; font-family: 'DM Mono', monospace;
    outline: none; transition: border-color 0.2s;
}
.form-group input:focus { border-color: var(--red); }
.form-group input::placeholder { color: var(--muted); }

.btn-login {
    width: 100%; background: var(--red); color: white; border: none;
    padding: 14px; font-size: 14px; font-weight: 700; font-family: 'Syne', sans-serif;
    letter-spacing: 1px; text-transform: uppercase; cursor: pointer;
    transition: background 0.2s; margin-top: 8px;
}
.btn-login:hover { background: var(--red2); }
.btn-login:disabled { opacity: 0.5; cursor: not-allowed; }

.login-error {
    color: var(--red); font-size: 12px; margin-top: 12px;
    padding: 10px 14px; background: rgba(230,57,70,0.1); border-left: 2px solid var(--red);
    display: none;
}

/* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
#dashboardPage { display: none; height: 100vh; flex-direction: column; }

.topbar {
    height: 56px; background: var(--bg2); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 24px; gap: 16px; flex-shrink: 0;
}
.topbar-logo { display: flex; align-items: center; gap: 8px; margin-right: auto; }
.topbar-logo-diamond { width: 8px; height: 8px; background: var(--red); transform: rotate(45deg); }
.topbar-logo span { font-size: 12px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; }
.topbar-badge { font-size: 10px; font-family: 'DM Mono'; background: var(--bg3); border: 1px solid var(--border); padding: 3px 8px; color: var(--muted); }
.topbar-user { font-size: 12px; color: var(--muted); font-family: 'DM Mono'; }
.btn-logout { background: none; border: 1px solid var(--border); color: var(--muted); padding: 6px 14px; font-size: 11px; font-family: 'Syne'; cursor: pointer; transition: all 0.2s; }
.btn-logout:hover { border-color: var(--red); color: var(--red); }

.dashboard-body { display: flex; flex: 1; overflow: hidden; }

/* Sidebar */
.sidebar {
    width: 200px; background: var(--bg2); border-right: 1px solid var(--border);
    display: flex; flex-direction: column; flex-shrink: 0;
}
.sidebar-nav { flex: 1; padding: 16px 0; }
.nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 20px; font-size: 12px; font-weight: 600; letter-spacing: 0.5px;
    color: var(--muted); cursor: pointer; transition: all 0.15s; border-left: 2px solid transparent;
    text-transform: uppercase;
}
.nav-item:hover { color: var(--text); background: var(--bg3); }
.nav-item.active { color: var(--red); border-left-color: var(--red); background: rgba(230,57,70,0.05); }
.nav-item .nav-icon { font-size: 14px; }
.sidebar-kill {
    padding: 16px; border-top: 1px solid var(--border);
}
.btn-kill {
    width: 100%; background: rgba(230,57,70,0.1); border: 1px solid rgba(230,57,70,0.3);
    color: var(--red); padding: 10px; font-size: 11px; font-weight: 700; font-family: 'Syne';
    letter-spacing: 1px; text-transform: uppercase; cursor: pointer; transition: all 0.2s;
}
.btn-kill:hover { background: var(--red); color: white; }

/* Main Content */
.main { flex: 1; overflow-y: auto; padding: 32px; }
.panel { display: none; }
.panel.active { display: block; }

.panel-title { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
.panel-sub { font-size: 12px; color: var(--muted); margin-bottom: 32px; font-family: 'DM Mono'; }

.card {
    background: var(--bg2); border: 1px solid var(--border);
    padding: 24px; margin-bottom: 16px;
}
.card-title { font-size: 11px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 16px; }

/* Stats cards */
.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px; }
.stat-card { background: var(--bg2); border: 1px solid var(--border); padding: 20px; }
.stat-label { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
.stat-value { font-size: 32px; font-weight: 800; font-family: 'DM Mono'; }
.stat-value.red { color: var(--red); }
.stat-sub { font-size: 11px; color: var(--muted); margin-top: 4px; font-family: 'DM Mono'; }

/* Model selector */
.model-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.model-card {
    border: 1px solid var(--border); padding: 16px; cursor: pointer;
    transition: all 0.2s; background: var(--bg3);
}
.model-card:hover { border-color: var(--red); }
.model-card.selected { border-color: var(--red); background: rgba(230,57,70,0.08); }
.model-card-name { font-size: 12px; font-weight: 700; margin-bottom: 4px; }
.model-card-desc { font-size: 11px; color: var(--muted); }
.model-card-badge { font-size: 9px; font-family: 'DM Mono'; background: var(--bg); border: 1px solid var(--border); padding: 2px 6px; margin-bottom: 8px; display: inline-block; }

/* Prompt editor */
.prompt-textarea {
    width: 100%; background: var(--bg3); border: 1px solid var(--border);
    color: var(--text); padding: 16px; font-size: 13px; font-family: 'DM Mono', monospace;
    outline: none; resize: vertical; min-height: 300px; transition: border-color 0.2s;
}
.prompt-textarea:focus { border-color: var(--red); }

.btn-save {
    background: var(--red); color: white; border: none;
    padding: 10px 24px; font-size: 12px; font-weight: 700; font-family: 'Syne';
    letter-spacing: 1px; text-transform: uppercase; cursor: pointer;
    transition: background 0.2s; margin-top: 12px;
}
.btn-save:hover { background: var(--red2); }

.success-msg { color: var(--success); font-size: 12px; margin-top: 8px; display: none; font-family: 'DM Mono'; }

/* File Manager */
.file-path { font-family: 'DM Mono'; font-size: 12px; color: var(--muted); padding: 10px 16px; background: var(--bg3); border: 1px solid var(--border); border-bottom: none; }
.file-list { border: 1px solid var(--border); }
.file-item {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 16px; border-bottom: 1px solid var(--border);
    cursor: pointer; transition: background 0.15s; font-size: 13px;
}
.file-item:last-child { border-bottom: none; }
.file-item:hover { background: var(--bg3); }
.file-item-icon { font-size: 14px; width: 20px; text-align: center; }
.file-item-name { flex: 1; font-family: 'DM Mono'; }
.file-item-size { font-size: 11px; color: var(--muted); font-family: 'DM Mono'; }
.file-editor { margin-top: 16px; display: none; }
.file-editor-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: var(--bg3); border: 1px solid var(--border); border-bottom: none; }
.file-editor-name { font-family: 'DM Mono'; font-size: 12px; color: var(--red); }
.file-editor-actions { display: flex; gap: 8px; }
.btn-sm { background: none; border: 1px solid var(--border); color: var(--muted); padding: 4px 12px; font-size: 11px; font-family: 'Syne'; cursor: pointer; transition: all 0.2s; }
.btn-sm:hover { border-color: var(--red); color: var(--red); }
.btn-sm.primary { background: var(--red); border-color: var(--red); color: white; }
.btn-sm.primary:hover { background: var(--red2); }
.file-content-editor {
    width: 100%; background: var(--bg3); border: 1px solid var(--border);
    color: var(--text); padding: 16px; font-size: 12px; font-family: 'DM Mono';
    outline: none; resize: vertical; min-height: 400px;
}

/* Chat */
#chatPanel { display: none; flex-direction: column; height: 100%; }
#chatPanel.active { display: flex; }
.chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
.chat-msg { max-width: 75%; }
.chat-msg.user { align-self: flex-end; }
.chat-msg.assistant { align-self: flex-start; }
.chat-bubble {
    padding: 12px 16px; font-size: 13px; line-height: 1.6;
}
.chat-msg.user .chat-bubble { background: var(--red); color: white; }
.chat-msg.assistant .chat-bubble { background: var(--bg3); border: 1px solid var(--border); }
.chat-input-wrap {
    display: flex; gap: 0; border-top: 1px solid var(--border); flex-shrink: 0;
}
.chat-input {
    flex: 1; background: var(--bg2); border: none; border-right: 1px solid var(--border);
    color: var(--text); padding: 16px; font-size: 13px; font-family: 'Syne'; outline: none;
}
.chat-input::placeholder { color: var(--muted); }
.btn-send {
    background: var(--red); border: none; color: white; padding: 16px 24px;
    font-size: 12px; font-weight: 700; font-family: 'Syne'; cursor: pointer;
    letter-spacing: 1px; text-transform: uppercase; transition: background 0.2s;
}
.btn-send:hover { background: var(--red2); }

/* Kill modal */
.modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.85);
    display: none; align-items: center; justify-content: center; z-index: 1000;
}
.modal-overlay.show { display: flex; }
.modal { background: var(--bg2); border: 1px solid var(--border); padding: 32px; width: 400px; }
.modal h3 { font-size: 20px; font-weight: 800; margin-bottom: 8px; }
.modal p { color: var(--muted); font-size: 13px; margin-bottom: 24px; }
.modal-actions { display: flex; gap: 10px; }
.btn-cancel { flex: 1; background: none; border: 1px solid var(--border); color: var(--muted); padding: 10px; font-family: 'Syne'; cursor: pointer; transition: all 0.2s; }
.btn-cancel:hover { border-color: var(--text); color: var(--text); }
.btn-confirm-kill { flex: 1; background: var(--red); border: none; color: white; padding: 10px; font-weight: 700; font-family: 'Syne'; cursor: pointer; transition: background 0.2s; }
.btn-confirm-kill:hover { background: var(--red2); }

/* Scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); }
::-webkit-scrollbar-thumb:hover { background: var(--muted); }
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage">
    <div class="login-left">
        <div class="login-logo">
            <div class="login-logo-diamond"></div>
            <span>EMK Admin</span>
        </div>
        <div class="login-hero">
            <h1>Bot Y√∂netim<span>Paneline<br>Ho≈ü Geldiniz</span></h1>
            <p>WhatsApp botunuzu buradan y√∂netin. Model se√ßimi, prompt d√ºzenleme ve canlƒ± izleme.</p>
        </div>
        <div class="login-features">
            <div class="login-feature">
                <div class="login-feature-icon">‚ö°</div>
                <div class="login-feature-text">
                    <strong>Anlƒ±k Kontrol</strong>
                    <span>Restart atmadan deƒüi≈üiklik</span>
                </div>
            </div>
            <div class="login-feature">
                <div class="login-feature-icon">üîí</div>
                <div class="login-feature-text">
                    <strong>G√ºvenli Eri≈üim</strong>
                    <span>JWT + Rate limiting korumasƒ±</span>
                </div>
            </div>
            <div class="login-feature">
                <div class="login-feature-icon">üìä</div>
                <div class="login-feature-text">
                    <strong>Token ƒ∞zleme</strong>
                    <span>API kullanƒ±m takibi</span>
                </div>
            </div>
        </div>
        <div class="login-footer">¬© 2026 EMK Bot ¬∑ T√ºm haklarƒ± saklƒ±dƒ±r</div>
    </div>

    <div class="login-right">
        <div class="login-form-wrap">
            <h2>Giri≈ü Yap</h2>
            <p>Y√∂netim panelinize devam edin</p>
            <div class="form-group">
                <label>Kullanƒ±cƒ± Adƒ±</label>
                <input type="text" id="loginUsername" placeholder="admin" autocomplete="username">
            </div>
            <div class="form-group">
                <label>≈ûifre</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
            </div>
            <button class="btn-login" id="loginBtn" onclick="doLogin()">Giri≈ü Yap</button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardPage">
    <div class="topbar">
        <div class="topbar-logo">
            <div class="topbar-logo-diamond"></div>
            <span>EMK Admin</span>
        </div>
        <span class="topbar-badge" id="topbarModel">claude-haiku</span>
        <span class="topbar-user" id="topbarUser"></span>
        <button class="btn-logout" onclick="doLogout()">√áƒ±kƒ±≈ü</button>
    </div>

    <div class="dashboard-body">
        <div class="sidebar">
            <nav class="sidebar-nav">
                <div class="nav-item active" onclick="showPanel('stats')">
                    <span class="nav-icon">üìä</span> ƒ∞statistik
                </div>
                <div class="nav-item" onclick="showPanel('model')">
                    <span class="nav-icon">ü§ñ</span> Model
                </div>
                <div class="nav-item" onclick="showPanel('prompt')">
                    <span class="nav-icon">üìù</span> Prompt
                </div>
                <div class="nav-item" onclick="showPanel('files')">
                    <span class="nav-icon">üìÅ</span> Dosyalar
                </div>
                <div class="nav-item" onclick="showPanel('chat')">
                    <span class="nav-icon">üí¨</span> AI Chat
                </div>
            </nav>
            <div class="sidebar-kill">
                <button class="btn-kill" onclick="showKillModal()">‚õî Kill Switch</button>
            </div>
        </div>

        <div class="main">
            <!-- Stats Panel -->
            <div class="panel active" id="statsPanel">
                <div class="panel-title">ƒ∞statistikler</div>
                <div class="panel-sub">Token kullanƒ±mƒ± ve bot durumu</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Toplam Token</div>
                        <div class="stat-value red" id="statTotal">‚Äî</div>
                        <div class="stat-sub">T√ºm zamanlar</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Bug√ºn</div>
                        <div class="stat-value" id="statToday">‚Äî</div>
                        <div class="stat-sub">Son 24 saat</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Aktif Model</div>
                        <div class="stat-value" style="font-size:16px;margin-top:8px" id="statModel">‚Äî</div>
                        <div class="stat-sub">≈ûu an kullanƒ±lan</div>
                    </div>
                </div>
            </div>

            <!-- Model Panel -->
            <div class="panel" id="modelPanel">
                <div class="panel-title">Model Se√ßimi</div>
                <div class="panel-sub">Aktif Claude modelini deƒüi≈ütirin</div>
                <div class="card">
                    <div class="card-title">Mevcut Modeller</div>
                    <div class="model-grid">
                        <div class="model-card" id="model-haiku" onclick="selectModel('claude-haiku-4-5-20251001')">
                            <div class="model-card-badge">HIZLI</div>
                            <div class="model-card-name">Haiku 4.5</div>
                            <div class="model-card-desc">Hƒ±zlƒ±, ekonomik. G√ºnl√ºk kullanƒ±m i√ßin ideal.</div>
                        </div>
                        <div class="model-card" id="model-sonnet" onclick="selectModel('claude-sonnet-4-6')">
                            <div class="model-card-badge">DENGELƒ∞</div>
                            <div class="model-card-name">Sonnet 4.6</div>
                            <div class="model-card-desc">Zeka ve hƒ±z dengesi.</div>
                        </div>
                        <div class="model-card" id="model-opus" onclick="selectModel('claude-opus-4-6')">
                            <div class="model-card-badge">G√ú√áL√ú</div>
                            <div class="model-card-name">Opus 4.6</div>
                            <div class="model-card-desc">En g√º√ßl√º model. Y√ºksek maliyet.</div>
                        </div>
                    </div>
                    <div class="success-msg" id="modelSuccess">‚úì Model g√ºncellendi.</div>
                </div>
            </div>

            <!-- Prompt Panel -->
            <div class="panel" id="promptPanel">
                <div class="panel-title">Master Prompt</div>
                <div class="panel-sub">Botun sistem promptunu d√ºzenleyin ‚Äî restart gerekmez</div>
                <div class="card">
                    <div class="card-title">Sistem Promptu</div>
                    <textarea class="prompt-textarea" id="promptEditor" placeholder="Sistem promptunu buraya girin..."></textarea>
                    <button class="btn-save" onclick="savePrompt()">Kaydet</button>
                    <div class="success-msg" id="promptSuccess">‚úì Prompt kaydedildi.</div>
                </div>
            </div>

            <!-- Files Panel -->
            <div class="panel" id="filesPanel">
                <div class="panel-title">Dosya Y√∂neticisi</div>
                <div class="panel-sub">Bot dizinindeki dosyalara eri≈üin</div>
                <div class="card">
                    <div class="file-path" id="filePath">/</div>
                    <div class="file-list" id="fileList"></div>
                    <div class="file-editor" id="fileEditor">
                        <div class="file-editor-header">
                            <span class="file-editor-name" id="editorFileName"></span>
                            <div class="file-editor-actions">
                                <button class="btn-sm" onclick="closeEditor()">ƒ∞ptal</button>
                                <button class="btn-sm primary" onclick="saveFile()">Kaydet</button>
                            </div>
                        </div>
                        <textarea class="file-content-editor" id="fileContent"></textarea>
                    </div>
                </div>
            </div>

            <!-- Chat Panel -->
            <div class="panel" id="chatPanel">
                <div class="panel-title">AI Chat</div>
                <div class="panel-sub">Claude ile doƒürudan konu≈üun</div>
                <div class="card" style="display:flex;flex-direction:column;height:calc(100vh - 220px);padding:0;overflow:hidden;">
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-msg assistant">
                            <div class="chat-bubble">Merhaba! Bot y√∂netimi hakkƒ±nda soru sorabilirsin.</div>
                        </div>
                    </div>
                    <div class="chat-input-wrap">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." onkeydown="if(event.key==='Enter')sendChat()">
                        <button class="btn-send" onclick="sendChat()">G√∂nder</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Kill Modal -->
<div class="modal-overlay" id="killModal">
    <div class="modal">
        <h3>‚õî Kill Switch</h3>
        <p>Bot <strong>anƒ±nda kapatƒ±lacak</strong>. Bu i≈ülem geri alƒ±namaz. Devam etmek istiyor musunuz?</p>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="hideKillModal()">ƒ∞ptal</button>
            <button class="btn-confirm-kill" onclick="confirmKill()">Evet, Kapat</button>
        </div>
    </div>
</div>

<script>
let csrfToken = '';
let chatHistory = [];
let currentPath = '/';
let currentFile = '';

async function getCsrf() {
    const r = await fetch('/api/csrf-token');
    const d = await r.json();
    csrfToken = d.token;
}

async function doLogin() {
    const btn = document.getElementById('loginBtn');
    const err = document.getElementById('loginError');
    err.style.display = 'none';
    btn.disabled = true;
    btn.textContent = 'Giri≈ü yapƒ±lƒ±yor...';

    await getCsrf();

    const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-csrf-token': csrfToken },
        body: JSON.stringify({
            username: document.getElementById('loginUsername').value,
            password: document.getElementById('loginPassword').value
        })
    });

    const data = await res.json();
    if (data.success) {
        await initDashboard();
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('dashboardPage').style.display = 'flex';
    } else {
        err.textContent = data.error || 'Giri≈ü ba≈üarƒ±sƒ±z.';
        err.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Giri≈ü Yap';
    }
}

async function doLogout() {
    await fetch('/api/logout', { method: 'POST', headers: { 'x-csrf-token': csrfToken } });
    location.reload();
}

async function initDashboard() {
    const me = await (await fetch('/api/me')).json();
    document.getElementById('topbarUser').textContent = me.username;

    const cfg = await (await fetch('/api/config')).json();
    const modelName = cfg.model?.includes('haiku') ? 'Haiku' : cfg.model?.includes('sonnet') ? 'Sonnet' : 'Opus';
    document.getElementById('topbarModel').textContent = modelName;
    document.getElementById('statModel').textContent = modelName;
    document.getElementById('promptEditor').value = cfg.systemPrompt || '';

    // Mark selected model
    document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
    if (cfg.model?.includes('haiku')) document.getElementById('model-haiku').classList.add('selected');
    else if (cfg.model?.includes('sonnet')) document.getElementById('model-sonnet').classList.add('selected');
    else if (cfg.model?.includes('opus')) document.getElementById('model-opus').classList.add('selected');

    const stats = await (await fetch('/api/stats')).json();
    document.getElementById('statTotal').textContent = (stats.total || 0).toLocaleString();
    document.getElementById('statToday').textContent = (stats.today || 0).toLocaleString();

    await loadFiles('/');
}

function showPanel(name) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(name + 'Panel').classList.add('active');
    event.currentTarget.classList.add('active');
}

async function selectModel(model) {
    const res = await fetch('/api/config/model', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-csrf-token': csrfToken },
        body: JSON.stringify({ model })
    });
    if ((await res.json()).success) {
        document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
        const map = { 'claude-haiku-4-5-20251001': 'haiku', 'claude-sonnet-4-6': 'sonnet', 'claude-opus-4-6': 'opus' };
        document.getElementById('model-' + map[model])?.classList.add('selected');
        const msg = document.getElementById('modelSuccess');
        msg.style.display = 'block';
        setTimeout(() => msg.style.display = 'none', 3000);
    }
}

async function savePrompt() {
    const prompt = document.getElementById('promptEditor').value;
    const res = await fetch('/api/config/prompt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-csrf-token': csrfToken },
        body: JSON.stringify({ prompt })
    });
    if ((await res.json()).success) {
        const msg = document.getElementById('promptSuccess');
        msg.style.display = 'block';
        setTimeout(() => msg.style.display = 'none', 3000);
    }
}

async function loadFiles(path) {
    currentPath = path;
    document.getElementById('filePath').textContent = path;
    const res = await fetch('/api/files?path=' + encodeURIComponent(path));
    const data = await res.json();
    const list = document.getElementById('fileList');
    list.innerHTML = '';
    if (path !== '/') {
        const up = document.createElement('div');
        up.className = 'file-item';
        up.innerHTML = '<span class="file-item-icon">‚Üë</span><span class="file-item-name">..</span>';
        up.onclick = () => loadFiles(path.split('/').slice(0, -1).join('/') || '/');
        list.appendChild(up);
    }
    (data.items || []).forEach(item => {
        const el = document.createElement('div');
        el.className = 'file-item';
        el.innerHTML = `<span class="file-item-icon">${item.type === 'dir' ? 'üìÅ' : 'üìÑ'}</span>
            <span class="file-item-name">${item.name}</span>
            <span class="file-item-size">${item.size ? formatSize(item.size) : ''}</span>`;
        if (item.type === 'dir') el.onclick = () => loadFiles(path.endsWith('/') ? path + item.name : path + '/' + item.name);
        else el.onclick = () => openFile(path.endsWith('/') ? path + item.name : path + '/' + item.name, item.name);
        list.appendChild(el);
    });
}

async function openFile(filePath, name) {
    currentFile = filePath;
    const res = await fetch('/api/files/read?path=' + encodeURIComponent(filePath));
    const data = await res.json();
    document.getElementById('editorFileName').textContent = name;
    document.getElementById('fileContent').value = data.content || '';
    document.getElementById('fileEditor').style.display = 'block';
}

async function saveFile() {
    const res = await fetch('/api/files/write', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-csrf-token': csrfToken },
        body: JSON.stringify({ path: currentFile, content: document.getElementById('fileContent').value })
    });
    if ((await res.json()).success) closeEditor();
}

function closeEditor() {
    document.getElementById('fileEditor').style.display = 'none';
}

function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
}

async function sendChat() {
    const input = document.getElementById('chatInput');
    const msg = input.value.trim();
    if (!msg) return;
    input.value = '';

    const msgs = document.getElementById('chatMessages');
    msgs.innerHTML += `<div class="chat-msg user"><div class="chat-bubble">${escHtml(msg)}</div></div>`;
    msgs.scrollTop = msgs.scrollHeight;

    chatHistory.push({ role: 'user', content: msg });

    const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-csrf-token': csrfToken },
        body: JSON.stringify({ message: msg, history: chatHistory.slice(-10) })
    });
    const data = await res.json();
    const reply = data.reply || 'Yanƒ±t alƒ±namadƒ±.';
    chatHistory.push({ role: 'assistant', content: reply });

    msgs.innerHTML += `<div class="chat-msg assistant"><div class="chat-bubble">${escHtml(reply)}</div></div>`;
    msgs.scrollTop = msgs.scrollHeight;
}

function escHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

function showKillModal() { document.getElementById('killModal').classList.add('show'); }
function hideKillModal() { document.getElementById('killModal').classList.remove('show'); }

async function confirmKill() {
    await fetch('/api/killswitch', { method: 'POST', headers: { 'x-csrf-token': csrfToken } });
    document.querySelector('.modal p').textContent = 'Bot kapatƒ±ldƒ±.';
    document.querySelector('.modal-actions').innerHTML = '';
}

// Enter ile login
document.getElementById('loginPassword').addEventListener('keydown', e => {
    if (e.key === 'Enter') doLogin();
});

// Oturum kontrol√º
(async () => {
    const res = await fetch('/api/me');
    if (res.ok) {
        await getCsrf();
        await initDashboard();
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('dashboardPage').style.display = 'flex';
    }
})();
</script>
</body>
</html>
